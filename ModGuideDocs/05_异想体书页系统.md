# 异想体书页系统操作手册

## 一、异想体书页概述

异想体书页是战斗中通过情感等级获得的特殊书页，具有强大的效果。

### 机制补充(官方规则)

- 异想体书页是司书在接待中获得的临时增益书页. 一次接待中全队最多选择5张异想体书页.
- 进入都市梦魇后, 来宾也会在情感等级到达3级时装备异想体书页(效果与司书方不同).
- 每次团队情感等级提升时, 可从3张异想体书页中选择1张.
- 异想体书页分为觉醒型与崩溃型:
  - 觉醒型提供强力正面效果.
  - 崩溃型提供更强的正面效果, 但可能附带负面效果.
- 不同异想体书页有不同的情感硬币比例需求与情感等级需求, 详见异想体书页选取区间.
- 本页面为当前游戏内异想体书页效果. 旧版或废除内容见废设异想体书页.

### BaseMod 如何辅助制作异想体书页

- 静态数据加载:
  - BaseMod 会从各 Mod 的 `StaticInfo/EmotionCard` 读取异想体书页 XML.
  - 会从各 Mod 的 `StaticInfo/EmotionEgo` 读取情感 EGO 相关 XML.
- 本地化加载:
  - BaseMod 会从 `Localize/<语言>/AbnormalityCards` 与 `Localize/<语言>/AbnormalityAbilities` 读取异想体书页与能力描述.
  - 若当前语言不存在, 会回退到 `Localize/default/` 目录.
- C# 能力脚本绑定:
  - BaseMod 会自动注册名称以 `EmotionCardAbility_` 开头的类.
  - XML 中 `<Script>` 填写的名字会映射到 `EmotionCardAbility_` 后缀.
- 卡图资源加载:
  - BaseMod 会扫描 Mod 根目录的 `ArtWork/` 并按文件名注册 Sprite.
  - 异想体书页 XML 的 `<Artwork>` 会从 `ArtWork/` 中按同名图片加载, 并在预览与选择界面显示.

---

## 二、异想体书页XML定义

### 异想体能力定义 (Data/EmotionCard/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<EmotionCardXmlRoot>
  <EmotionCard ID="MyMod_Abnormality_001">
    <Name>异想体名称</Name>
    <Sephirah>Keter</Sephirah>
    <TargetType>SelectOne</TargetType>
    <Level>1</Level>
    <EmotionRate>Positive</EmotionRate>
    <Script>MyMod_AbnormalityAbility</Script>
    <State>Enabled</State>
  </EmotionCard>
</EmotionCardXmlRoot>
```

### 属性说明

| 标签 | 说明 | 可选值 |
|------|------|--------|
| `Sephirah` | 所属层 | `Keter`, `Malkuth`, `Yesod`, `Hod`, `Netzach`, `Tiphereth`, `Gebura`, `Chesed`, `Binah`, `Hokma` |
| `TargetType` | 目标类型 | `SelectOne`(选择一人), `All`(全体), `AllIncludingEnemy`(包括敌人) |
| `Level` | 情感等级要求 | `1`~`5` |
| `EmotionRate` | 情感类型 | `Positive`(正面), `Negative`(负面) |
| `State` | 状态 | `Enabled`, `Disabled` |

---

## 三、异想体能力C#实现

### 基础结构

```csharp
public class EmotionCardAbility_MyMod_AbnormalityAbility : EmotionCardAbilityBase
{
    // 应用异想体书页时触发
    public override void OnSelectEmotion()
    {
        // 选择时的效果
        _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 3, _owner);
    }

    // 每幕开始时
    public override void OnRoundStart()
    {
        _owner.RecoverHP(5);
    }

    // 每幕结束时
    public override void OnRoundEnd()
    {
        // 幕结束效果
    }

    // 使用书页时
    public override void OnUseCard(BattlePlayingCardDataInUnitModel curCard)
    {
        // 使用书页时的效果
    }

    // 攻击成功时
    public override void OnSucceedAttack(BattleDiceBehavior behavior)
    {
        // 攻击成功效果
    }

    // 拼点胜利时
    public override void OnWinParrying(BattleDiceBehavior behavior)
    {
        _owner.cardSlotDetail.RecoverPlayPoint(1);
    }

    // 受到伤害后
    public override void AfterTakeDamage(BattleUnitModel attacker, int dmg)
    {
        // 受伤后效果
    }

    // 击杀时
    public override void OnKill(BattleUnitModel target)
    {
        _owner.RecoverHP(20);
    }
}
```

---

## 四、复杂异想体示例

### 带有多阶段效果的异想体

```csharp
public class EmotionCardAbility_MyMod_PhaseAbnormality : EmotionCardAbilityBase
{
    private int _attackCount = 0;
    private bool _transformed = false;

    public override void OnSelectEmotion()
    {
        _attackCount = 0;
        _transformed = false;
        // 初始效果
        _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 2, _owner);
    }

    public override void OnSucceedAttack(BattleDiceBehavior behavior)
    {
        _attackCount++;

        // 攻击5次后变身
        if (_attackCount >= 5 && !_transformed)
        {
            _transformed = true;
            Transform();
        }
    }

    private void Transform()
    {
        // 变身效果
        _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 3, _owner);
        _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Endurance, 3, _owner);
        _owner.RecoverHP(30);

        // 可以添加视觉效果
        // SingletonBehavior<BattleManagerUI>.Instance.ui_unitListInfoSummary
        //     .UpdateCharacterProfile(_owner, _owner.faction, _owner.index);
    }

    public override void OnRoundStart()
    {
        if (_transformed)
        {
            // 变身后每幕效果
            _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 1, _owner);
        }
    }
}
```

### 带有负面效果的异想体

```csharp
public class EmotionCardAbility_MyMod_RiskyAbnormality : EmotionCardAbilityBase
{
    public override void OnSelectEmotion()
    {
        // 强大的正面效果
        _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 5, _owner);
        _owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Quickness, 3, _owner);
    }

    public override void OnRoundEnd()
    {
        // 每幕结束受到伤害作为代价
        _owner.TakeDamage(5, DamageType.Emotion, null);
    }

    public override void OnSucceedAttack(BattleDiceBehavior behavior)
    {
        // 攻击成功恢复HP来抵消代价
        _owner.RecoverHP(3);
    }
}
```

---

## 五、异想体本地化

### 异想体描述 (Localize/cn/AbnormalityCards/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<AbnormalityCardsRoot>
  <AbnormalityCard ID="MyMod_Abnormality_001">
    <Abnormality>异想体名称</Abnormality>
    <CardName>书页名称</CardName>
    <AbilityDesc>[幕开始] 恢复5点HP
[攻击成功] 获得1层强壮</AbilityDesc>
    <FlaborText>这是异想体的风味文本...</FlaborText>
    <Dialogues>
      <Dialogue>选择时的台词1</Dialogue>
      <Dialogue>选择时的台词2</Dialogue>
    </Dialogues>
  </AbnormalityCard>
</AbnormalityCardsRoot>
```

---

## 六、异想体图标

| 属性 | 规格 |
|------|------|
| 格式 | PNG |
| 尺寸 | 建议 256x256 像素 |
| 位置 | 需要通过AssetBundle加载 |

---

## 七、自定义异想体书页（战斗书页形式）

有时需要创建类似异想体效果的战斗书页，而不是情感书页：

### XML定义

```xml
<Card ID="9000501">
  <Name>异想体之力</Name>
  <Artwork>Abnormality_Power.png</Artwork>
  <Rarity>Unique</Rarity>
  <Option>EgoPersonal</Option>
  <Spec Range="Near" Cost="0" />
  <Script>MyMod_AbnormalityPower</Script>
  <BehaviourList>
    <Behaviour Min="8" Dice="15" Type="Atk" Detail="Slash" Motion="S1"
               EffectRes="Abnormality_Slash" Script="MyMod_AbnormalityDice" Desc="" />
    <Behaviour Min="6" Dice="12" Type="Atk" Detail="Hit" Motion="S2"
               EffectRes="Abnormality_Hit" Script="" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>100</Priority>
</Card>
```

### C#实现

```csharp
public class DiceCardSelfAbility_MyMod_AbnormalityPower : DiceCardSelfAbilityBase
{
    public static string Desc = "[使用时] 获得异想体之力的祝福";

    public override void OnUseCard()
    {
        // 强大的使用效果
        owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 3, owner);
        owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Endurance, 3, owner);

        // 全体友军效果
        foreach (var ally in BattleObjectManager.instance.GetAliveList(owner.faction))
        {
            ally.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Protection, 2, owner);
        }
    }

    public override void OnSucceedAttack(BattleDiceBehavior behavior)
    {
        // 攻击成功恢复HP
        owner.RecoverHP(5);
    }
}

public class DiceCardAbility_MyMod_AbnormalityDice : DiceCardAbilityBase
{
    public static string Desc = "[命中时] 对目标施加异想体诅咒";

    public override void OnSucceedAttack(BattleUnitModel target)
    {
        if (target != null)
        {
            // 施加多种负面效果
            target.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Weak, 2, owner);
            target.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Vulnerable, 2, owner);
            target.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Binding, 2, owner);
        }
    }
}
```

---

## 八、通过被动触发异想体书页

```csharp
public class PassiveAbility_MyMod_AbnormalityTrigger : PassiveAbilityBase
{
    private bool _triggered = false;

    public override void OnRoundEnd()
    {
        // 情感等级达到3级时触发
        if (!_triggered && owner.emotionDetail.EmotionLevel >= 3)
        {
            _triggered = true;
            TriggerAbnormality();
        }
    }

    private void TriggerAbnormality()
    {
        // 添加异想体书页到手牌
        var cardId = new LorId("MyModId", 9000501);
        var card = owner.allyCardDetail.AddNewCard(cardId);

        if (card != null)
        {
            owner.allyCardDetail.AddCardToHand(card);
        }

        // 或者直接添加到EGO栏位
        // owner.personalEgoDetail.AddCard(cardId);
    }

    public override void OnWaveStart()
    {
        _triggered = false;
    }
}
```

---

## 九、E.G.O书页系统

### E.G.O书页定义

```xml
<Card ID="9000601">
  <Name>E.G.O - 寒霜</Name>
  <Artwork>EGO_Frost.png</Artwork>
  <Rarity>Unique</Rarity>
  <Option>EgoPersonal</Option>
  <Spec Range="FarAreaEach" Cost="5" Affection="Team"/>
  <Script>MyMod_EGO_Frost</Script>
  <BehaviourList>
    <Behaviour Min="10" Dice="18" Type="Atk" Detail="Penetrate" Motion="S1"
               EffectRes="" Script="MyMod_EGO_FrostDice" ActionScript="EGO_FrostAction" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>100</Priority>
</Card>
```

### 在核心书页中添加E.G.O

```xml
<Book ID="10000001">
  <!-- ... 其他属性 ... -->
  <EquipEffect>
    <!-- ... -->
    <!-- E.G.O书页 -->
    <OnlyCard>9000601</OnlyCard>
  </EquipEffect>
</Book>
```

### 通过被动控制E.G.O可用性

```csharp
public class PassiveAbility_MyMod_EGOController : PassiveAbilityBase
{
    private bool _egoUnlocked = false;

    public override void OnRoundEnd()
    {
        // 情感等级4级解锁E.G.O
        if (!_egoUnlocked && owner.emotionDetail.EmotionLevel >= 4)
        {
            _egoUnlocked = true;
            UnlockEGO();
        }
    }

    private void UnlockEGO()
    {
        // 添加E.G.O书页
        var egoCardId = new LorId("MyModId", 9000601);
        owner.personalEgoDetail.AddCard(egoCardId);
    }
}
```
