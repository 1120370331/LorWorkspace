# 完整示例与常见问题

## 一、完整角色制作流程

### 步骤1：创建核心书页 (EquipPage_Librarian.xml)

```xml
<Book ID="10000001">
  <Name>刘夜</Name>
  <TextId>-1</TextId>
  <EquipEffect>
    <HP>101</HP>
    <Break>54</Break>
    <SpeedMin>4</SpeedMin>
    <Speed>6</Speed>
    <StartPlayPoint>4</StartPlayPoint>
    <MaxPlayPoint>4</MaxPlayPoint>
    <SResist>Endure</SResist>
    <PResist>Normal</PResist>
    <HResist>Normal</HResist>
    <SBResist>Normal</SBResist>
    <PBResist>Normal</PBResist>
    <HBResist>Endure</HBResist>
    <Passive Pid="@origin">10008</Passive>
    <Passive>9000001</Passive>
    <Passive>9000002</Passive>
    <Passive>9000003</Passive>
    <OnlyCard>9000101</OnlyCard>
    <OnlyCard>9000102</OnlyCard>
    <OnlyCard>9000103</OnlyCard>
  </EquipEffect>
  <Chapter>6</Chapter>
  <Episode>1</Episode>
  <BookIcon>MyMod_LiuYe</BookIcon>
  <Rarity>Unique</Rarity>
  <CharacterSkin>mymod_liuye</CharacterSkin>
  <CharacterSkinType>Lor</CharacterSkinType>
</Book>
```

### 步骤2：创建被动能力 (PassiveList.xml)

```xml
<!-- 可转移被动 -->
<Passive ID="9000001">
  <Rarity>Rare</Rarity>
  <Cost>4</Cost>
  <Name>寒夜无昼</Name>
  <Desc>与速度低于自己的目标拼点时使自身的进攻型骰子威力+1</Desc>
  <Script>MyMod_ColdNight</Script>
</Passive>

<!-- 不可转移被动 -->
<Passive ID="9000002">
  <Rarity>Unique</Rarity>
  <Cost>0</Cost>
  <CanGivePassive>false</CanGivePassive>
  <Name>寒昼之阳</Name>
  <Desc>情感等级达到4级时展现E.G.O</Desc>
  <Script>MyMod_ColdSun</Script>
</Passive>

<!-- 固有被动 -->
<Passive ID="9000003">
  <Rarity>Unique</Rarity>
  <Cost>5</Cost>
  <Name>凝结冻固</Name>
  <Desc>目标每有1层束缚便使目标骰子最小值-1</Desc>
  <Script>MyMod_Freeze</Script>
</Passive>
```

### 步骤3：创建战斗书页 (CardInfo.xml)

```xml
<!-- 专属书页1 -->
<Card ID="9000101">
  <Name>往日追忆</Name>
  <Artwork>MyMod_LY01.png</Artwork>
  <Rarity>Unique</Rarity>
  <Option>OnlyPage</Option>
  <Keyword>onlypage_MyMod_LY</Keyword>
  <Spec Range="Near" Cost="3" />
  <Script>MyMod_Memory</Script>
  <BehaviourList>
    <Behaviour Min="9" Dice="21" Type="Atk" Detail="Penetrate" Motion="Z"
               EffectRes="MyMod_Ice_Z" Script="binding3atk" Desc="" />
    <Behaviour Min="9" Dice="10" Type="Atk" Detail="Slash" Motion="J"
               EffectRes="MyMod_Ice_J" Script="vulnerable1atk" Desc="" />
    <Behaviour Min="9" Dice="10" Type="Atk" Detail="Hit" Motion="H"
               EffectRes="MyMod_Ice_H" Script="bleeding3atk" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>2</Priority>
</Card>

<!-- 普通书页 -->
<Card ID="9000102">
  <Name>剑影凝霜</Name>
  <Artwork>MyMod_Normal01.png</Artwork>
  <Rarity>Common</Rarity>
  <Spec Range="Near" Cost="1" />
  <Script></Script>
  <BehaviourList>
    <Behaviour Min="4" Dice="8" Type="Atk" Detail="Slash" Motion="J"
               EffectRes="" Script="binding1atk" Desc="" />
    <Behaviour Min="3" Dice="7" Type="Atk" Detail="Penetrate" Motion="Z"
               EffectRes="" Script="" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>0</Priority>
</Card>

<!-- E.G.O书页 -->
<Card ID="9000103">
  <Name>绝对零度</Name>
  <Artwork>MyMod_EGO01.png</Artwork>
  <Rarity>Unique</Rarity>
  <Spec Range="Near" Cost="4" Affection="TeamNear"/>
  <Option>EgoPersonal</Option>
  <Script>MyMod_AbsoluteZero</Script>
  <BehaviourList>
    <Behaviour Min="11" Dice="19" Type="Atk" Detail="Penetrate" Motion="S1"
               EffectRes="" Script="MyMod_EGODice" ActionScript="MyMod_EGOAction" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>100</Priority>
</Card>
```

### 步骤4：编写C#代码

```csharp
// === 被动能力 ===
public class PassiveAbility_MyMod_ColdNight : PassiveAbilityBase
{
    public override void BeforeRollDice(BattleDiceBehavior behavior)
    {
        if (behavior.card?.target == null) return;

        // 检查速度差
        int mySpeed = owner.GetSpeed(behavior.card.slotOrder);
        int targetSpeed = behavior.card.target.GetSpeed(behavior.card.targetSlotOrder);

        if (mySpeed > targetSpeed && IsAttackDice(behavior.Detail))
        {
            behavior.ApplyDiceStatBonus(new DiceStatBonus { power = 1 });
        }
    }
}

public class PassiveAbility_MyMod_ColdSun : PassiveAbilityBase
{
    private bool _egoUnlocked = false;

    public override void OnRoundEnd()
    {
        if (!_egoUnlocked && owner.emotionDetail.EmotionLevel >= 4)
        {
            _egoUnlocked = true;
            var egoId = new LorId("MyModId", 9000103);
            owner.personalEgoDetail.AddCard(egoId);
        }
    }
}

public class PassiveAbility_MyMod_Freeze : PassiveAbilityBase
{
    public override void BeforeRollDice(BattleDiceBehavior behavior)
    {
        if (behavior.card?.target == null) return;

        var bindingBuf = behavior.card.target.bufListDetail.GetActivatedBuf(KeywordBuf.Binding);
        if (bindingBuf != null && bindingBuf.stack > 0)
        {
            int reduction = Math.Min(bindingBuf.stack, 5);
            behavior.ApplyDiceStatBonus(new DiceStatBonus { min = -reduction });
        }
    }
}

// === 书页效果 ===
public class DiceCardSelfAbility_MyMod_Memory : DiceCardSelfAbilityBase
{
    public static string Desc = "[使用时] 获得2层强壮";

    public override void OnUseCard()
    {
        owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 2, owner);
    }
}

public class DiceCardSelfAbility_MyMod_AbsoluteZero : DiceCardSelfAbilityBase
{
    public static string Desc = "[使用时] 对所有敌人施加2层束缚";

    public override void OnUseCard()
    {
        foreach (var enemy in BattleObjectManager.instance.GetAliveList(
            owner.faction == Faction.Player ? Faction.Enemy : Faction.Player))
        {
            enemy.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Binding, 2, owner);
        }
    }
}

// === 骰子效果 ===
public class DiceCardAbility_MyMod_EGODice : DiceCardAbilityBase
{
    public static string Desc = "[命中时] 施加5层束缚并恢复10HP";

    public override void OnSucceedAttack(BattleUnitModel target)
    {
        if (target != null)
        {
            target.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Binding, 5, owner);
        }
        owner.RecoverHP(10);
    }
}
```

### 步骤5：创建本地化文件

**Localize/cn/Books/Books.xml:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<BookDescRoot>
  <BookDesc BookID="10000001">
    <Name>刘夜之页</Name>
    <Desc>寒昼事务所的核心成员</Desc>
  </BookDesc>
</BookDescRoot>
```

**Localize/cn/PassiveDesc/PassiveDesc.xml:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<PassiveDescRoot>
  <PassiveDesc ID="9000001">
    <Name>寒夜无昼</Name>
    <Desc>与速度低于自己的目标拼点时使自身的[进攻型]骰子威力+1</Desc>
  </PassiveDesc>
  <PassiveDesc ID="9000002">
    <Name>寒昼之阳</Name>
    <Desc>情感等级达到4级时展现E.G.O</Desc>
  </PassiveDesc>
  <PassiveDesc ID="9000003">
    <Name>凝结冻固</Name>
    <Desc>目标每有1层"束缚"便使目标骰子最小值-1(至多-5)</Desc>
  </PassiveDesc>
</PassiveDescRoot>
```

**Localize/cn/BattleCards/BattleCards.xml:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<CardDescXmlRoot>
  <cardDescList>
    <BattleCardDesc ID="9000101">
      <Name>往日追忆</Name>
      <Desc>[使用时] 获得2层强壮</Desc>
      <BehaviourDescList>
        <BehaviourDesc>[命中时] 施加3层束缚</BehaviourDesc>
        <BehaviourDesc>[命中时] 施加1层易伤</BehaviourDesc>
        <BehaviourDesc>[命中时] 施加3层流血</BehaviourDesc>
      </BehaviourDescList>
    </BattleCardDesc>
  </cardDescList>
</CardDescXmlRoot>
```

---

## 二、常见问题与解决方案

### Q1: 被动/书页效果不生效

**检查项：**
1. C#类名是否与XML中`<Script>`标签完全一致
2. DLL是否正确放置在`Assemblies/`目录
3. 是否正确继承了基类
4. ID是否冲突

### Q2: 本地化文本不显示

**检查项：**
1. XML文件编码是否为UTF-8
2. ID是否与定义文件中的ID完全一致
3. 文件夹结构是否正确（cn/en/kr）
4. XML根节点是否正确

### Q3: 卡面图片不显示

**检查项：**
1. 图片是否为PNG格式
2. 文件名是否与`<Artwork>`标签一致
3. 图片是否放在`Resource/CombatPageArtwork/`

### Q4: 专属书页不出现

**检查项：**
1. 核心书页中是否添加了`<OnlyCard>`
2. 卡牌是否设置了`<Option>OnlyPage</Option>`
3. ID是否正确关联

### Q5: E.G.O书页无法使用

**检查项：**
1. 是否设置了`<Option>EgoPersonal</Option>`
2. 是否通过被动或其他方式解锁
3. 费用是否足够

### Q6: 编译错误

**常见原因：**
1. 缺少引用DLL
2. 命名空间冲突
3. 方法签名不正确

**解决方案：**
```csharp
// 确保引用正确
using LOR_DiceSystem;
using BaseMod;
using UnityEngine;
```

### Q7: XML解析错误 "There is an error in XML document (行, 列)"

**这类错误通常不是语法问题，而是枚举值填错！**

游戏中有多个名称相似但值不同的枚举类型，容易混淆：

#### 1. 范围类型枚举（最常见错误）

| 枚举类型 | 用于 | 有效值 |
|---------|------|--------|
| `CardRange` | 战斗书页 `<Spec Range="...">` | `Near`, `Far`, `FarArea`, `FarAreaEach`, `Special`, `Instance` |
| `EquipRangeType` | 核心书页 `<RangeType>` | `Melee`, `Range`, `Hybrid` |

**错误示例：**
```xml
<!-- ❌ 错误：Near 是 CardRange 的值，不是 EquipRangeType 的值 -->
<RangeType>Near</RangeType>

<!-- ✅ 正确：使用 EquipRangeType 的有效值 -->
<RangeType>Melee</RangeType>
```

#### 2. 其他常见枚举对照表

| 枚举类型 | 用于 | 有效值 |
|---------|------|--------|
| `Rarity` | 稀有度 | `Common`, `Uncommon`, `Rare`, `Unique`, `Special` |
| `AtkResist` | 抗性 | `Weak`, `Normal`, `Endure`, `Immune` |
| `CardAffection` | 书页影响范围 | `One`, `Team`, `All`, `Passive`, `TeamNear` |
| `BehaviourType` | 骰子类型 | `Atk`, `Def`, `Standby` |
| `BehaviourDetail` | 骰子细节 | `Slash`, `Penetrate`, `Hit`, `Guard`, `Evasion` |

**调试技巧：** 当遇到 "error in XML document (行, 列)" 错误时：
1. 定位到报错行附近
2. 检查该行及上下文中的枚举值是否正确
3. 查阅游戏源码确认枚举的有效值

---

## 三、调试技巧

### 使用Debug.Log

```csharp
public override void OnUseCard()
{
    Debug.Log($"[MyMod] OnUseCard triggered for {owner.UnitData.unitData.name}");
    // 效果代码
}
```

### 查看游戏日志

日志位置：`%USERPROFILE%\AppData\LocalLow\Project Moon\LibraryOfRuina\`

### 使用UnityExplorer

安装UnityExplorer可以在游戏中实时查看对象状态。

---

## 四、性能优化建议

1. **避免在频繁调用的方法中创建对象**
```csharp
// 不好
public override void BeforeRollDice(BattleDiceBehavior behavior)
{
    var bonus = new DiceStatBonus { power = 1 }; // 每次创建新对象
    behavior.ApplyDiceStatBonus(bonus);
}

// 好
private static readonly DiceStatBonus _powerBonus = new DiceStatBonus { power = 1 };
public override void BeforeRollDice(BattleDiceBehavior behavior)
{
    behavior.ApplyDiceStatBonus(_powerBonus);
}
```

2. **缓存查询结果**
```csharp
private BattleUnitModel _cachedTarget;
private int _lastRound = -1;

public override void OnRoundStart()
{
    _lastRound = Singleton<StageController>.Instance.RoundCount;
    _cachedTarget = null; // 重置缓存
}
```

3. **使用条件检查提前返回**
```csharp
public override void OnSucceedAttack(BattleUnitModel target)
{
    if (target == null) return;
    if (target.IsDead()) return;
    // 实际效果
}
```

---

## 五、推荐工具

| 工具 | 用途 |
|------|------|
| dnSpy | 反编译查看游戏代码 |
| Visual Studio | C#开发 |
| Unity | 制作AssetBundle |
| UnityExplorer | 游戏内调试 |
| Notepad++ | XML编辑 |

---

## 六、参考资源

- 寒昼事务所V4.0 - 完整模组示例
- Assembly-CSharp反编译 - 官方代码参考
- BaseMod文档 - 框架使用说明
