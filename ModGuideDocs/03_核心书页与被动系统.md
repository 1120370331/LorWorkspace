# 核心书页与被动系统操作手册

## 一、核心书页定义 (EquipPage_Librarian.xml)

### 基础结构

```xml
<?xml version="1.0" encoding="utf-8"?>
<BookXmlRoot xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Version>1.1</Version>

  <Book ID="10000001">
    <Name>角色名称</Name>
    <TextId>-1</TextId>
    <EquipEffect>
      <HP>100</HP>
      <Break>53</Break>
      <SpeedMin>3</SpeedMin>
      <Speed>6</Speed>
      <StartPlayPoint>4</StartPlayPoint>
      <MaxPlayPoint>4</MaxPlayPoint>

      <!-- 抗性设置 -->
      <SResist>Normal</SResist>
      <PResist>Normal</PResist>
      <HResist>Endure</HResist>
      <SBResist>Normal</SBResist>
      <PBResist>Normal</PBResist>
      <HBResist>Endure</HBResist>

      <!-- 被动列表 -->
      <Passive Pid="@origin">10008</Passive>
      <Passive>9000001</Passive>
      <Passive>9000002</Passive>

      <!-- 专属书页 -->
      <OnlyCard>9000101</OnlyCard>
      <OnlyCard>9000102</OnlyCard>
    </EquipEffect>
    <Chapter>6</Chapter>
    <Episode>1</Episode>
    <BookIcon>MyModIcon</BookIcon>
    <Rarity>Unique</Rarity>
    <CharacterSkin>my_character_skin</CharacterSkin>
    <CharacterSkinType>Lor</CharacterSkinType>
  </Book>

</BookXmlRoot>
```

---

## 二、核心书页属性详解

### 抗性值 (Resist)

| 值 | 说明 | 伤害倍率 |
|----|------|----------|
| `Weak` | 脆弱 | 2.0x |
| `Normal` | 普通 | 1.0x |
| `Endure` | 耐性 | 0.5x |
| `Immune` | 免疫 | 0x |
| `Fatal` | 致命 | 3.0x |

### 抗性类型

| 标签 | 说明 |
|------|------|
| `SResist` | 斩击HP抗性 |
| `PResist` | 穿刺HP抗性 |
| `HResist` | 打击HP抗性 |
| `SBResist` | 斩击混乱抗性 |
| `PBResist` | 穿刺混乱抗性 |
| `HBResist` | 打击混乱抗性 |

### 被动引用方式

```xml
<!-- 引用模组内被动（使用模组内ID） -->
<Passive>9000001</Passive>

<!-- 引用原版被动（使用@origin前缀） -->
<Passive Pid="@origin">10008</Passive>

<!-- 引用原版专属书页 -->
<OnlyCard Pid="@origin">602001</OnlyCard>
```

### 核心书页选项

```xml
<!-- 多卡组支持 -->
<Option>MultiDeck</Option>

<!-- 远近混合类型 -->
<RangeType>Hybrid</RangeType>

<!-- 分类 -->
<Category>TheIndex</Category>
<Category>Thumb</Category>
```

---

## 三、被动能力定义 (PassiveList.xml)

### 基础结构

```xml
<?xml version="1.0" encoding="utf-8"?>
<PassiveXmlRoot xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- 可转移被动 -->
  <Passive ID="9000001">
    <Rarity>Rare</Rarity>
    <Cost>4</Cost>
    <Name>寒夜无昼</Name>
    <Desc>与速度低于自己的目标拼点时使自身的进攻型骰子威力+1</Desc>
    <Script>MyMod_ColdNight</Script>
  </Passive>

  <!-- 不可转移被动 -->
  <Passive ID="9000002">
    <Rarity>Unique</Rarity>
    <Cost>0</Cost>
    <CanGivePassive>false</CanGivePassive>
    <Name>寒昼之阳</Name>
    <Desc>每一幕结束时若情感等级已达到4级则展现E.G.O</Desc>
    <Script>MyMod_ColdSun</Script>
  </Passive>

  <!-- 固有被动（通过InnerType关联） -->
  <Passive ID="9000003">
    <Rarity>Rare</Rarity>
    <Cost>4</Cost>
    <InnerType>10000302</InnerType>
    <Name>次元武装</Name>
    <Desc>近战书页击中目标时获得1层充能</Desc>
    <Script>MyMod_DimensionArm</Script>
  </Passive>

</PassiveXmlRoot>
```

---

## 四、被动类型说明

### 可转移被动
- 默认情况，可以通过燃烧书页转移给其他角色
- 不需要特殊标签

### 不可转移被动
```xml
<CanGivePassive>false</CanGivePassive>
```
- 无法通过燃烧转移
- 通常用于角色专属机制

### 固有被动 (InnerType)
```xml
<InnerType>10000302</InnerType>
```
- 同一InnerType的被动互斥
- 用于实现"升级"或"替换"机制
- 例如：基础版和强化版被动使用相同InnerType

---

## 五、C#被动能力实现

### PassiveAbilityBase 常用方法

```csharp
public class PassiveAbility_MyMod_ColdNight : PassiveAbilityBase
{
    // === 回合/幕相关 ===

    // 每一幕开始时
    public override void OnRoundStart()
    {
        owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 1, owner);
    }

    // 每一幕结束时
    public override void OnRoundEnd()
    {
        // 幕结束效果
    }

    // 战斗开始时（整场战斗）
    public override void OnWaveStart()
    {
        // 开场效果
    }

    // === 骰子相关 ===

    // 投骰前（可修改骰子）
    public override void BeforeRollDice(BattleDiceBehavior behavior)
    {
        // 检查是否为攻击骰子
        if (IsAttackDice(behavior.Detail))
        {
            behavior.ApplyDiceStatBonus(new DiceStatBonus { power = 1 });
        }
    }

    // 投骰后
    public override void OnRollDice(BattleDiceBehavior behavior)
    {
        // 投骰后效果
    }

    // 造成伤害前
    public override void BeforeGiveDamage(BattleDiceBehavior behavior)
    {
        // 伤害前效果
    }

    // === 拼点相关 ===

    // 拼点胜利
    public override void OnWinParrying(BattleDiceBehavior behavior)
    {
        owner.cardSlotDetail.RecoverPlayPoint(1);
    }

    // 拼点失败
    public override void OnLoseParrying(BattleDiceBehavior behavior)
    {
        // 拼点失败效果
    }

    // 攻击成功
    public override void OnSucceedAttack(BattleDiceBehavior behavior)
    {
        // 攻击成功效果
    }

    // === 受伤相关 ===

    // 受到伤害前（返回true则无效化伤害）
    public override bool BeforeTakeDamage(BattleUnitModel attacker, int dmg)
    {
        return false; // 返回true无效化伤害
    }

    // 受到伤害后
    public override void AfterTakeDamage(BattleUnitModel attacker, int dmg)
    {
        // 受伤后效果
    }

    // 伤害减免
    public override int GetDamageReductionAll()
    {
        return 2; // 所有伤害-2
    }

    // === 死亡相关 ===

    // 自身死亡时
    public override void OnDie()
    {
        // 死亡效果
    }

    // 其他单位死亡时
    public override void OnDieOtherUnit(BattleUnitModel unit)
    {
        if (unit.faction != owner.faction) // 敌人死亡
        {
            owner.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Strength, 1, owner);
        }
    }

    // 击杀目标时
    public override void OnKill(BattleUnitModel target)
    {
        owner.RecoverHP(10);
    }

    // === 属性修改 ===

    // 速度骰子数量加成
    public override int SpeedDiceNumAdder()
    {
        return 1; // +1速度骰
    }

    // 速度骰子结果加成
    public override int GetSpeedDiceAdder(int speedDiceResult)
    {
        return 1; // 速度+1
    }

    // 最大HP加成
    public override int GetMaxHpBonus()
    {
        return 20;
    }

    // 最大光芒加成
    public override int MaxPlayPointAdder()
    {
        return 1;
    }

    // === 免疫相关 ===

    // 免疫特定Buff
    public override bool IsImmune(KeywordBuf buf)
    {
        return buf == KeywordBuf.Binding; // 免疫束缚
    }

    // 是否无敌
    public override bool isInvincible => false;

    // 是否不朽（HP不会降到0）
    public override bool isImmortal => false;
}
```

---

## 六、随幕变化被动示例（类似变幻莫测）

```csharp
public class PassiveAbility_MyMod_Changeling : PassiveAbilityBase
{
    private int _currentPhase = 0;
    private int _roundCount = 0;

    public override void OnRoundStart()
    {
        _roundCount++;

        // 每3幕切换一次形态
        if (_roundCount % 3 == 1)
        {
            _currentPhase = (_currentPhase + 1) % 4;
            ApplyPhaseEffect();
        }
    }

    private void ApplyPhaseEffect()
    {
        // 清除之前的效果
        owner.bufListDetail.RemoveBufAll(typeof(BattleUnitBuf_MyPhase));

        switch (_currentPhase)
        {
            case 0: // 攻击形态
                owner.bufListDetail.AddBuf(new BattleUnitBuf_MyPhase_Attack());
                break;
            case 1: // 防御形态
                owner.bufListDetail.AddBuf(new BattleUnitBuf_MyPhase_Defense());
                break;
            case 2: // 速度形态
                owner.bufListDetail.AddBuf(new BattleUnitBuf_MyPhase_Speed());
                break;
            case 3: // 恢复形态
                owner.bufListDetail.AddBuf(new BattleUnitBuf_MyPhase_Recovery());
                break;
        }
    }

    // 根据形态修改骰子威力
    public override void BeforeRollDice(BattleDiceBehavior behavior)
    {
        if (_currentPhase == 0 && IsAttackDice(behavior.Detail))
        {
            behavior.ApplyDiceStatBonus(new DiceStatBonus { power = 2 });
        }
    }

    // 根据形态修改伤害减免
    public override int GetDamageReductionAll()
    {
        return _currentPhase == 1 ? 3 : 0;
    }

    // 根据形态修改速度
    public override int GetSpeedDiceAdder(int speedDiceResult)
    {
        return _currentPhase == 2 ? 2 : 0;
    }

    public override void OnRoundEnd()
    {
        if (_currentPhase == 3)
        {
            owner.RecoverHP(10);
            owner.breakDetail.RecoverBreak(5);
        }
    }
}
```

---

## 七、被动本地化 (Localize/cn/PassiveDesc/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<PassiveDescRoot>
  <PassiveDesc ID="9000001">
    <Name>寒夜无昼</Name>
    <Desc>与速度低于自己的目标拼点时使自身的[进攻型]骰子威力+1</Desc>
  </PassiveDesc>

  <PassiveDesc ID="9000002">
    <Name>寒昼之阳</Name>
    <Desc>每一幕结束时若情感等级已达到4级则展现E.G.O
(本被动能力不可转移)</Desc>
  </PassiveDesc>
</PassiveDescRoot>
```

---

## 八、核心书页本地化 (Localize/cn/Books/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<BookDescRoot>
  <BookDesc BookID="10000001">
    <Name>刘夜之页</Name>
    <Desc>寒昼事务所的核心成员，擅长冰属性攻击。</Desc>
  </BookDesc>
</BookDescRoot>
```

---

## 九、角色皮肤（外观）制作

关于角色皮肤的详细制作方法，请参阅 **[10_角色外观与特效系统.md](10_角色外观与特效系统.md)**。

### 快速参考

在核心书页中关联皮肤：

```xml
<Book ID="10000001">
    <CharacterSkin>my_character_skin</CharacterSkin>
    <CharacterSkinType>Lor</CharacterSkinType>
</Book>
```
