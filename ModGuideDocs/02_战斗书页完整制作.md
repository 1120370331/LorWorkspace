# 战斗书页完整制作操作手册

## 一、CardInfo.xml 战斗书页定义

### 基础结构

```xml
<?xml version="1.0" encoding="utf-8"?>
<DiceCardXmlRoot xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Version>1.1</Version>

  <Card ID="9000001">
    <Name>书页名称</Name>
    <Artwork>MyCard01.png</Artwork>
    <Rarity>Rare</Rarity>
    <Spec Range="Near" Cost="2" />
    <Script>MyCardSelfAbility</Script>
    <BehaviourList>
      <Behaviour Min="4" Dice="8" Type="Atk" Detail="Slash" Motion="J"
                 EffectRes="MyEffect_J" Script="MyDiceAbility" Desc="" />
    </BehaviourList>
    <Chapter>6</Chapter>
    <Priority>0</Priority>
  </Card>

</DiceCardXmlRoot>
```

---

## 二、书页属性详解

### 稀有度 `<Rarity>`

| 值 | 说明 | 卡面颜色 |
|----|------|----------|
| `Common` | 普通 | 绿色 |
| `Uncommon` | 罕见 | 蓝色 |
| `Rare` | 稀有 | 紫色 |
| `Unique` | 独特 | 金色 |

### 距离 `<Spec Range="...">`

| 值 | 说明 |
|----|------|
| `Near` | 近战 |
| `Far` | 远程 |
| `Instance` | 瞬发（对自己使用） |
| `FarArea` | 群攻-清算（不交锋） |
| `FarAreaEach` | 群攻-交锋（逐一交锋） |

### 群攻影响范围 `<Spec Affection="...">`

| 值 | 说明 |
|----|------|
| `Team` | 影响所有敌人 |
| `TeamNear` | 影响附近敌人 |

### 书页选项 `<Option>`

| 值 | 说明 |
|----|------|
| `OnlyPage` | 专属书页（需配合核心书页的OnlyCard） |
| `ExhaustOnUse` | 使用后销毁（佚亡） |
| `EgoPersonal` | E.G.O个人书页 |
| `Personal` | 个人书页 |
| `NoInventory` | 不在书库显示 |
| `MultiDeck` | 可装备多套卡组 |

---

## 三、骰子属性详解

### 骰子类型 `Type`

| 值 | 说明 |
|----|------|
| `Atk` | 攻击骰子 |
| `Def` | 防御骰子 |
| `Standby` | 反击骰子（被单方面攻击时才触发） |

### 骰子细节 `Detail`

| 值 | 说明 | 图标 |
|----|------|------|
| `Slash` | 斩击 | 斩击 |
| `Penetrate` | 穿刺 | 穿刺 |
| `Hit` | 打击 | 打击 |
| `Guard` | 防御 | 盾牌 |
| `Evasion` | 回避 | 闪避 |

### 动作 `Motion`

| 值 | 说明 |
|----|------|
| `H` | 打击通用动画 |
| `J` | 斩击通用动画 |
| `Z` | 穿刺通用动画 |
| `G` | 防御动画 |
| `E` | 回避动画 |
| `F` | 远程攻击动画 |
| `S1`~`S9` | 特殊动画（需自定义） |

---

## 四、完整示例：带所有功能的战斗书页

```xml
<Card ID="9000001">
  <Name>寒霜斩击</Name>
  <Artwork>FrostSlash.png</Artwork>
  <Rarity>Unique</Rarity>
  <Option>OnlyPage</Option>
  <Option>ExhaustOnUse</Option>
  <Keyword>onlypage_MyChar_Keyword</Keyword>
  <Spec Range="Near" Cost="3" />
  <Script>MyMod_FrostSlash</Script>
  <BehaviourList>
    <!-- 骰子1: 斩击攻击，命中时施加束缚 -->
    <Behaviour Min="5" Dice="9" Type="Atk" Detail="Slash" Motion="J"
               EffectRes="FrostEffect_J" Script="binding2atk"
               ActionScript="MyMod_SlashAction" Desc="" />
    <!-- 骰子2: 防御骰子 -->
    <Behaviour Min="3" Dice="7" Type="Def" Detail="Guard" Motion="G"
               EffectRes="FrostEffect_G" Script="" Desc="" />
    <!-- 骰子3: 穿刺攻击，自定义效果 -->
    <Behaviour Min="4" Dice="8" Type="Atk" Detail="Penetrate" Motion="Z"
               EffectRes="FrostEffect_Z" Script="MyMod_FrostDice" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>5</Priority>
</Card>
```

---

## 五、群攻书页示例

### 交锋型群攻 (FarAreaEach)

```xml
<Card ID="9000002">
  <Name>昙花一现</Name>
  <Artwork>FlashAttack.png</Artwork>
  <Rarity>Unique</Rarity>
  <Spec Range="FarAreaEach" Cost="6" Affection="Team"/>
  <Option>OnlyPage</Option>
  <Script>MyMod_FlashAttack</Script>
  <BehaviourList>
    <Behaviour Min="4" Dice="9" Type="Atk" Detail="Slash" Motion="J"
               EffectRes="" Script="MyMod_FlashDice" ActionScript="FlashAction" Desc="" />
    <Behaviour Min="4" Dice="9" Type="Atk" Detail="Slash" Motion="J"
               EffectRes="" Script="MyMod_FlashDice" ActionScript="FlashAction" Desc="" />
    <Behaviour Min="4" Dice="7" Type="Atk" Detail="Slash" Motion="J"
               EffectRes="" Script="MyMod_FlashDice" ActionScript="FlashAction" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>9000</Priority>
</Card>
```

### 清算型群攻 (FarArea)

```xml
<Card ID="9000003">
  <Name>绝对零度</Name>
  <Artwork>AbsoluteZero.png</Artwork>
  <Rarity>Unique</Rarity>
  <Spec Range="FarArea" Cost="4" Affection="Team"/>
  <Script>MyMod_AbsoluteZero</Script>
  <BehaviourList>
    <Behaviour Min="30" Dice="30" Type="Atk" Detail="Hit" Motion="S3"
               EffectRes="" Script="MyMod_ZeroDice" ActionScript="ZeroAction" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>999</Priority>
</Card>
```

---

## 六、装备书页（Instance类型）

装备书页是一种特殊的书页类型，使用后**立即生效**，不需要选择目标，也不参与拼点。游戏中的"不详之力"就是典型的装备书页。

### 与普通战斗书页的区别

| 特性 | 普通战斗书页 | 装备书页 |
|------|-------------|----------|
| Range | `Near` / `Far` | `Instance` |
| 触发方法 | `OnUseCard()` | `OnUseInstance()` |
| 需要选择目标 | 是 | 否 |
| 参与拼点 | 是 | 否 |
| 骰子类型 | `Atk` / `Def` | 通常使用 `Standby` 占位 |

### XML定义示例

```xml
<!-- 装备书页示例：不详之力类型 -->
<Card ID="9000010">
  <Name>能量注入</Name>
  <Artwork>EnergyInject.png</Artwork>
  <Rarity>Uncommon</Rarity>
  <Spec Range="Instance" Cost="0" />
  <Script>MyMod_EnergyInject</Script>
  <BehaviourList>
    <!-- 装备书页通常使用Standby类型骰子作为占位符 -->
    <Behaviour Min="1" Dice="1" Type="Standby" Detail="Hit" Motion="H"
               EffectRes="" Script="" ActionScript="" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>0</Priority>
</Card>
```

### 带冷却时间的EGO装备书页

```xml
<!-- EGO装备书页示例：带冷却时间 -->
<Card ID="9000011">
  <Name>自我之流</Name>
  <Artwork>SelfFlow.png</Artwork>
  <Rarity>Unique</Rarity>
  <Spec Range="Instance" Cost="1" />
  <Option>EgoPersonal</Option>
  <MaxCooltimeForEgo>4</MaxCooltimeForEgo>
  <Script>MyMod_SelfFlow</Script>
  <BehaviourList>
    <Behaviour Min="1" Dice="1" Type="Standby" Detail="Hit" Motion="H"
               EffectRes="" Script="" ActionScript="" Desc="" />
  </BehaviourList>
  <Chapter>6</Chapter>
  <Priority>0</Priority>
</Card>
```

### C#脚本实现

**重要**：装备书页必须使用 `OnUseInstance()` 方法，而不是 `OnUseCard()`！

```csharp
// 装备书页效果实现
public class DiceCardSelfAbility_MyMod_EnergyInject : DiceCardSelfAbilityBase
{
    public static string Desc = "[装备时] 恢复3点光芒，下回合失去3点光芒";

    // 装备书页使用 OnUseInstance 而不是 OnUseCard
    public override void OnUseInstance(BattleUnitModel unit, BattleDiceCardModel self, BattleUnitModel targetUnit)
    {
        // unit: 使用书页的单位
        // self: 书页本身
        // targetUnit: 目标单位（装备书页通常为null）

        int currentLight = unit.cardSlotDetail.PlayPoint;
        int recovered = unit.cardSlotDetail.RecoverPlayPointByCard(3);

        // 如果恢复的光芒超过了原有值，下回合失去多余部分
        if (recovered > currentLight)
        {
            unit.cardSlotDetail.LoseWhenStartRound(recovered - currentLight);
        }
    }
}

// EGO装备书页示例
public class DiceCardSelfAbility_MyMod_SelfFlow : DiceCardSelfAbilityBase
{
    public static string Desc = "[装备时] 扣除25点生命值，获得10层[流]";

    public override string[] Keywords => new string[] { "MyFlowKeyword" };

    public override void OnUseInstance(BattleUnitModel unit, BattleDiceCardModel self, BattleUnitModel targetUnit)
    {
        // 扣除生命值
        unit.LoseHp(25);

        // 添加自定义Buff
        // CardAbilityHelper.AddFlowStacks(unit, 10);

        // 或者添加游戏内置Buff
        unit.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Strength, 3, unit);
    }
}
```

### OnUseInstance 方法参数说明

```csharp
public override void OnUseInstance(
    BattleUnitModel unit,        // 使用书页的单位
    BattleDiceCardModel self,    // 书页数据模型
    BattleUnitModel targetUnit   // 目标单位（装备书页通常为null）
)
```

**注意事项**：
- 在 `OnUseInstance` 中使用 `unit` 参数而不是 `this.owner`
- 装备书页的骰子不会实际投掷，只是占位符
- 可以配合 `<Option>EgoPersonal</Option>` 和 `<MaxCooltimeForEgo>` 实现带冷却的EGO装备

---

## 七、C#书页效果实现

### 书页使用时效果 (DiceCardSelfAbilityBase)

```csharp
// 文件: MyMod_FrostSlash.cs
public class DiceCardSelfAbility_MyMod_FrostSlash : DiceCardSelfAbilityBase
{
    public static string Desc = "[使用时] 获得2层强壮";

    // 使用书页时触发
    public override void OnUseCard()
    {
        owner.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 2, owner);
    }

    // 战斗开始时触发（书页被选中后）
    public override void OnStartBattle()
    {
        // 战斗开始时的效果
    }

    // 战斗结束时触发
    public override void OnEndBattle()
    {
        // 战斗结束时的效果
    }

    // 拼点胜利时触发（攻击方）
    public override void OnWinParryingAtk()
    {
        owner.cardSlotDetail.RecoverPlayPoint(1); // 恢复1光芒
    }

    // 攻击成功时触发
    public override void OnSucceedAttack()
    {
        owner.allyCardDetail.DrawCards(1); // 抽1张牌
    }
}
```

### 骰子命中时效果 (DiceCardAbilityBase)

```csharp
// 文件: MyMod_FrostDice.cs
public class DiceCardAbility_MyMod_FrostDice : DiceCardAbilityBase
{
    public static string Desc = "[命中时] 对目标施加3层束缚";

    // 攻击成功时触发
    public override void OnSucceedAttack(BattleUnitModel target)
    {
        if (target != null)
        {
            target.bufListDetail.AddKeywordBufByEtc(KeywordBuf.Binding, 3, owner);
        }
    }

    // 拼点胜利时触发
    public override void OnWinParrying()
    {
        owner.RecoverHP(5); // 恢复5点HP
    }

    // 拼点失败时触发
    public override void OnLoseParrying()
    {
        // 拼点失败的效果
    }

    // 投骰前触发
    public override void BeforeRollDice()
    {
        behavior.ApplyDiceStatBonus(new DiceStatBonus { power = 2 }); // 威力+2
    }
}
```

---

## 八、本地化文件

### 卡牌名称描述 (Localize/cn/BattleCards/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<CardDescXmlRoot>
  <cardDescList>
    <BattleCardDesc ID="9000001">
      <Name>寒霜斩击</Name>
      <Desc>[使用时] 获得2层强壮</Desc>
      <BehaviourDescList>
        <BehaviourDesc>[命中时] 施加2层束缚</BehaviourDesc>
        <BehaviourDesc></BehaviourDesc>
        <BehaviourDesc>[命中时] 施加3层束缚</BehaviourDesc>
      </BehaviourDescList>
    </BattleCardDesc>
  </cardDescList>
</CardDescXmlRoot>
```

### 骰子效果描述 (Localize/cn/BattleCardAbilities/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<BattleCardAbilityDescRoot>
  <BattleCardAbility ID="MyMod_FrostDice">
    <Desc>[命中时] 对目标施加3层束缚</Desc>
  </BattleCardAbility>
</BattleCardAbilityDescRoot>
```

---

## 九、卡面图片规格

| 属性 | 规格 |
|------|------|
| 格式 | PNG |
| 尺寸 | 建议 330x480 像素 |
| 位置 | `Resource/CombatPageArtwork/` |
| 命名 | 与XML中`<Artwork>`一致 |

---

## 十、常用内置骰子效果Script

| Script名称 | 效果 |
|------------|------|
| `binding1atk` | 命中时施加1层束缚 |
| `binding2atk` | 命中时施加2层束缚 |
| `binding3atk` | 命中时施加3层束缚 |
| `bleeding1atk` | 命中时施加1层流血 |
| `bleeding2atk` | 命中时施加2层流血 |
| `bleeding3atk` | 命中时施加3层流血 |
| `burn1atk` | 命中时施加1层烧伤 |
| `vulnerable1atk` | 命中时施加1层易伤 |
| `paralysis1atk` | 命中时施加1层麻痹 |
| `recoverHp5atk` | 命中时恢复5点HP |
| `recoverBreak5atk` | 命中时恢复5点混乱抗性 |
| `drawCard` | 命中时抽1张牌 |
| `drawCard2` | 命中时抽2张牌 |
| `energy1` | 命中时恢复1光芒 |
