# 敌人与关卡系统操作手册

## 一、敌人单位定义 (EnemyUnitInfo.xml)

### 基础结构

```xml
<?xml version="1.0" encoding="utf-8"?>
<EnemyUnitClassRoot>
  <EnemyUnit ID="9000001">
    <Name>敌人名称</Name>
    <NameID>MyMod_Enemy01</NameID>
    <MinHeight>180</MinHeight>
    <MaxHeight>190</MaxHeight>
    <BookId>10000001</BookId>
    <DeckId>9000001</DeckId>
    <DropTable>9000001</DropTable>
  </EnemyUnit>
</EnemyUnitClassRoot>
```

### 属性说明

| 标签 | 说明 |
|------|------|
| `BookId` | 关联的核心书页ID |
| `DeckId` | 关联的卡组ID |
| `DropTable` | 关联的掉落表ID |
| `MinHeight/MaxHeight` | 身高范围（影响模型缩放） |

---

## 二、敌人卡组定义 (Deck_Enemy.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<DeckXmlRoot>
  <Deck ID="9000001">
    <Card>9000101</Card>
    <Card>9000101</Card>
    <Card>9000102</Card>
    <Card>9000102</Card>
    <Card>9000103</Card>
    <Card>9000103</Card>
    <Card>9000104</Card>
    <Card>9000105</Card>
    <Card>9000106</Card>
  </Deck>
</DeckXmlRoot>
```

---

## 三、关卡定义 (StageInfo.xml)

### 基础结构

```xml
<?xml version="1.0" encoding="utf-8"?>
<StageXmlRoot>
  <Stage ID="9000001">
    <Name>关卡名称</Name>
    <Chapter>6</Chapter>
    <StoryType>Default</StoryType>
    <Wave>
      <Formation>
        <Position>
          <UnitId>9000001</UnitId>
          <Pos>0</Pos>
          <Emotionlevel>0</Emotionlevel>
        </Position>
        <Position>
          <UnitId>9000002</UnitId>
          <Pos>1</Pos>
          <Emotionlevel>0</Emotionlevel>
        </Position>
      </Formation>
    </Wave>
    <Invitation>
      <Book>250001</Book>
      <Book>250002</Book>
    </Invitation>
    <StageRequire>
      <RequireType>Stage</RequireType>
      <RequireId>1</RequireId>
    </StageRequire>
    <FloorNum>5</FloorNum>
    <MapInfo>MyMod_Stage01</MapInfo>
    <FloorBgm>MyMod_BGM01</FloorBgm>
  </Stage>
</StageXmlRoot>
```

### 多波次关卡

```xml
<Stage ID="9000002">
  <Name>多波次关卡</Name>
  <Chapter>6</Chapter>
  <StoryType>Default</StoryType>

  <!-- 第一波 -->
  <Wave>
    <Formation>
      <Position>
        <UnitId>9000001</UnitId>
        <Pos>0</Pos>
      </Position>
      <Position>
        <UnitId>9000002</UnitId>
        <Pos>1</Pos>
      </Position>
    </Formation>
  </Wave>

  <!-- 第二波 -->
  <Wave>
    <Formation>
      <Position>
        <UnitId>9000003</UnitId>
        <Pos>0</Pos>
      </Position>
    </Formation>
    <AvailableUnit>3</AvailableUnit>
  </Wave>

  <!-- 第三波（Boss） -->
  <Wave>
    <Formation>
      <Position>
        <UnitId>9000004</UnitId>
        <Pos>0</Pos>
        <Emotionlevel>2</Emotionlevel>
      </Position>
    </Formation>
    <AvailableUnit>5</AvailableUnit>
  </Wave>

  <Invitation>
    <Book>250001</Book>
  </Invitation>
  <FloorNum>5</FloorNum>
</Stage>
```

---

## 四、剧情制作与接待绑定(StoryText / StoryEffect)

参考: `寒昼事务所V4.0` 的 `Data/StageInfo.xml`, `Data/StoryText/`, `Data/StoryEffect/`.

### 1) 在 StageInfo.xml 绑定剧情

使用 `<Story>` 绑定开场与结尾剧情, 并指定 `<StoryType>`:

```xml
<Stage id="1">
  <Name>寒昼0</Name>
  <Chapter>6</Chapter>
  <Story Condition="Start">ColdSun_HZ1.xml</Story>
  <Story Condition="End">ColdSun_HZ1_END.xml</Story>
  <StoryType>HZStory_HZ</StoryType>
  ...
</Stage>
```

要点:
- `Condition="Start"` 表示接待开始剧情, `Condition="End"` 表示接待结束剧情.
- `Story` 填文件名(含扩展名). 加载时按“文件基础名”匹配, 所以 `.xml` 或 `.txt` 都可.
- `StoryType` 用于区分剧情组(可自定义字符串, 与同组关卡保持一致).

### 2) StoryText(剧情文本)文件

路径: `Data/StoryText/`.

最小模板(参考 `寒昼事务所V4.0/Data/StoryText/测试.xml`):

```xml
<?xml version="1.0" encoding="utf-8"?>
<ScenarioRoot xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Chapter ID="-1">
    <Title />
  </Chapter>
  <Group>
    <GroupName>group</GroupName>
    <Episode>
      <EpisodeName>Episode</EpisodeName>
      <Place>
        <PlaceName>Place</PlaceName>
        <Dialog ID="0" Model="">
          <Teller />
          <Title />
          <Content />
        </Dialog>
      </Place>
    </Episode>
  </Group>
</ScenarioRoot>
```

要点:
- `Dialog ID` 必须与 StoryEffect 中的 `Dialogue ID` 对应, 否则表现对不上.
- 一个剧情文件可以包含多个 Place 与 Dialog.

多语言支持(BaseMod):
- BaseMod 会优先读取 `Data/StoryText/<语言>/` 下与基础名相同的文件.
- 若当前语言目录不存在, 会回退到 `BasemodConfig.DefaultLocale`.
- 建议结构: `Data/StoryText/cn/xxx.xml`, `Data/StoryText/en/xxx.xml` 等.

### 3) StoryEffect(演出效果)文件

路径: `Data/StoryEffect/`.

最小模板(参考 `寒昼事务所V4.0/Data/StoryEffect/测试.xml`):

```xml
<?xml version="1.0" encoding="utf-8"?>
<SceneEffect xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <CG />
  <storyBranch>None</storyBranch>
</SceneEffect>
```

常见用法:
- `Dialogue ID` 与 StoryText 的 `Dialog ID` 一一对应.
- 可配置 `Bg`, `Bgm`, `Filter`, `CharacterList`, `EffectSound` 等演出元素.
- 若不需要复杂演出, 保留最小模板即可避免报错.

### 4) CG 与背景图绑定

若在 StoryEffect 中使用 `<CG Src="xxx" />`:
- 将 CG 图片放在 `Resource/StoryBgSprite/`.
- 文件名需与 `Src` 对应(不含扩展名或直接写完整文件名均可, 参考寒昼项目用法).
- BaseMod 会在剧情面板中加载对应 CG.


## 四、掉落表定义 (CardDropTable.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<CardDropTableXmlRoot>
  <DropTable ID="9000001">
    <Card>
      <CardId>9000101</CardId>
      <Prob>100</Prob>
    </Card>
    <Card>
      <CardId>9000102</CardId>
      <Prob>80</Prob>
    </Card>
    <Card>
      <CardId>9000103</CardId>
      <Prob>50</Prob>
    </Card>
  </DropTable>
</CardDropTableXmlRoot>
```

---

## 五、书籍掉落定义 (Dropbook.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<BookUseXmlRoot>
  <BookUse ID="9000001">
    <TextId>9000001</TextId>
    <BookIcon>MyMod_BookIcon</BookIcon>
    <Chapter>6</Chapter>
    <DropItem>
      <Book>10000001</Book>
      <Prob>100</Prob>
    </DropItem>
    <DropItem>
      <Book>10000002</Book>
      <Prob>50</Prob>
    </DropItem>
  </BookUse>
</BookUseXmlRoot>
```

---

## 六、关卡管理器 (EnemyTeamStageManager)

### 基础结构

```csharp
public class EnemyTeamStageManager_MyMod_Stage01 : EnemyTeamStageManager
{
    // 关卡开始时
    public override void OnWaveStart()
    {
        base.OnWaveStart();
        // 初始化逻辑
    }

    // 每幕开始时
    public override void OnRoundStart()
    {
        base.OnRoundStart();
        // 幕开始逻辑
    }

    // 每幕结束时
    public override void OnRoundEnd()
    {
        base.OnRoundEnd();
        // 幕结束逻辑
    }

    // 敌人死亡时
    public override void OnDie(BattleUnitModel unit)
    {
        base.OnDie(unit);
        // 死亡处理
    }
}
```

### Boss战阶段管理

```csharp
public class EnemyTeamStageManager_MyMod_Boss : EnemyTeamStageManager
{
    private int _phase = 1;
    private BattleUnitModel _boss;

    public override void OnWaveStart()
    {
        base.OnWaveStart();
        _boss = BattleObjectManager.instance.GetAliveList(Faction.Enemy)
            .FirstOrDefault(x => x.UnitData.unitData.EnemyUnitId == 9000004);
        _phase = 1;
    }

    public override void OnRoundEnd()
    {
        base.OnRoundEnd();

        if (_boss == null || _boss.IsDead()) return;

        // 阶段转换
        float hpRatio = (float)_boss.hp / _boss.MaxHp;

        if (_phase == 1 && hpRatio <= 0.7f)
        {
            _phase = 2;
            EnterPhase2();
        }
        else if (_phase == 2 && hpRatio <= 0.3f)
        {
            _phase = 3;
            EnterPhase3();
        }
    }

    private void EnterPhase2()
    {
        // 第二阶段效果
        _boss.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 2, _boss);
        _boss.RecoverHP(30);

        // 召唤增援
        // ...
    }

    private void EnterPhase3()
    {
        // 第三阶段效果
        _boss.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 3, _boss);
        _boss.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Endurance, 3, _boss);
    }
}
```

---

## 七、召唤增援

```csharp
public class EnemyTeamStageManager_MyMod_Summon : EnemyTeamStageManager
{
    public override void OnRoundStart()
    {
        base.OnRoundStart();

        // 每3幕召唤一次增援
        if (Singleton<StageController>.Instance.RoundCount % 3 == 0)
        {
            SummonReinforcement();
        }
    }

    private void SummonReinforcement()
    {
        // 获取空位
        int emptyPos = GetEmptyPosition();
        if (emptyPos < 0) return;

        // 召唤单位
        var unitId = new LorId("MyModId", 9000002);
        var unit = Singleton<StageController>.Instance.AddNewUnit(
            Faction.Enemy,
            unitId,
            emptyPos
        );

        if (unit != null)
        {
            // 设置初始状态
            unit.bufListDetail.AddKeywordBufThisRoundByEtc(KeywordBuf.Strength, 1, unit);
        }
    }

    private int GetEmptyPosition()
    {
        var enemies = BattleObjectManager.instance.GetAliveList(Faction.Enemy);
        var usedPositions = enemies.Select(x => x.index).ToHashSet();

        for (int i = 0; i < 5; i++)
        {
            if (!usedPositions.Contains(i))
                return i;
        }
        return -1;
    }
}
```

---

## 八、关卡本地化

### 关卡名称 (Localize/cn/StageName/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<StageNameRoot>
  <StageName ID="9000001">
    <Name>寒昼事务所</Name>
    <SubName>第一章</SubName>
  </StageName>
</StageNameRoot>
```

### 敌人名称 (Localize/cn/CharacterName/)

```xml
<?xml version="1.0" encoding="utf-8"?>
<CharacterNameRoot>
  <Name ID="MyMod_Enemy01">刘夜</Name>
  <Name ID="MyMod_Enemy02">阿列克谢</Name>
</CharacterNameRoot>
```

---

## 九、邀请条件

### 需要特定书籍

```xml
<Invitation>
  <Book>250001</Book>  <!-- 拇指之书 -->
  <Book>250002</Book>  <!-- 食指之书 -->
</Invitation>
```

### 需要完成特定关卡

```xml
<StageRequire>
  <RequireType>Stage</RequireType>
  <RequireId>1</RequireId>
</StageRequire>
```

---

## 十、自定义地图

### 地图资源结构

```
Resource/Stage/
├── MyMod_Stage01/
│   ├── Floor.png           # 地板贴图
│   ├── Background.png      # 背景图
│   └── config.xml          # 地图配置
```

### 使用CustomMapUtility

```csharp
// 在ModInitializer中注册地图
public class ModInitializer : ModInitializer
{
    public override void OnInitializeMod()
    {
        // 注册自定义地图
        CustomMapHandler.RegisterMap("MyMod_Stage01", new MapInfo
        {
            FloorPath = "MyMod_Stage01/Floor.png",
            BackgroundPath = "MyMod_Stage01/Background.png"
        });
    }
}
```

---

## 十一、战斗对话 (Combat_Dialog.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<BattleDialogRoot>
  <Dialog ID="MyMod_Enemy01">
    <GroupName>刘夜</GroupName>
    <Dlg Type="Start">战斗开始了...</Dlg>
    <Dlg Type="Win">我赢了。</Dlg>
    <Dlg Type="Lose">不可能...</Dlg>
    <Dlg Type="Default">...</Dlg>
    <Dlg Type="Special_1">特殊台词1</Dlg>
    <Dlg Type="Special_2">特殊台词2</Dlg>
  </Dialog>
</BattleDialogRoot>
```

### 在代码中触发对话

```csharp
// 触发特殊对话
SingletonBehavior<BattleDialogUI>.Instance.SetDialog(
    owner.UnitData.unitData.workshopSkin,
    new List<AbnormalityCardDialog>
    {
        new AbnormalityCardDialog { dialog = "特殊台词内容" }
    }
);
```
