# 角色外观与特效系统

本文档详细介绍如何为核心书页制作角色外观（皮肤），以及如何创建和使用自定义战斗特效。

## 目录

- [一、角色皮肤概述](#一角色皮肤概述)
- [二、皮肤资源放置方式](#二皮肤资源放置方式)
- [三、ModInfo.xml配置详解](#三modinfoxml配置详解)
- [四、攻击特效位置配置](#四攻击特效位置配置)
- [五、动作音效绑定](#五动作音效绑定)
- [六、特效系统底层原理](#六特效系统底层原理)
- [七、自定义特效类（C#方式）](#七自定义特效类c方式)
- [八、使用原版特效](#八使用原版特效)
- [九、AssetBundle特效制作](#九assetbundle特效制作)
- [十、纯代码特效](#十纯代码特效)

---

## 一、角色皮肤概述

角色皮肤是核心书页在战斗中显示的立绘/动画。

### 在EquipPage中关联皮肤

```xml
<Book ID="10000001">
    <CharacterSkin>my_character_skin</CharacterSkin>
    <CharacterSkinType>Lor</CharacterSkinType>
    <RandomFace>true</RandomFace>  <!-- 可选：随机面部表情 -->
</Book>
```

| 标签 | 说明 |
|------|------|
| `CharacterSkin` | 皮肤名称，对应资源文件夹名 |
| `CharacterSkinType` | 设为 `Lor` 表示使用mod皮肤 |
| `RandomFace` | 可选，启用随机面部表情 |

---

## 二、皮肤资源放置方式

### 方式A: AssetBundle（推荐）

```
Resource/AssetBundle/[皮肤名称]
```

- Unity AssetBundle文件（无扩展名）
- 需要用Unity打包角色的Sprite动画
- 寒昼事务所等大型mod使用此方式
- 文件大小通常在1-15MB

### 方式B: 散图模式（ExtendedLoader支持）

```
Char/[皮肤名称]/
├── ModInfo.xml          # 皮肤配置文件（必须）
├── Default.png          # 默认站姿
├── Guard.png            # 防御
├── Evade.png            # 回避
├── Damaged.png          # 受伤
├── Slash.png            # 斩击
├── Slash2.png           # 斩击2
├── Penetrate.png        # 穿刺
├── Penetrate2.png       # 穿刺2
├── Hit.png              # 打击
├── Hit2.png             # 打击2
├── Move.png             # 移动
├── Fire.png             # 远程攻击
├── Aim.png              # 瞄准
├── Special.png          # 特殊动作
├── S1.png ~ S15.png     # 额外特殊动作
├── NONE.png             # 无动作
└── MotionSound/         # 动作音效（可选）
    ├── Slash.wav
    ├── Hit.wav
    └── ...
```

### 动作图片规格

| 属性 | 推荐值 |
|------|--------|
| 格式 | PNG（带透明通道） |
| 尺寸 | 512x512 或 1024x1024 |
| 色彩模式 | RGBA |

---

## 三、ModInfo.xml配置详解

散图模式必须包含 `ModInfo.xml` 配置文件：

```xml
<ModInfo Extended="true">
  <!-- 面部细节（可选） -->
  <FaceInfo>
    <Front_FrontHair>Front_FrontHair</Front_FrontHair>
    <Front_RearHair>Front_RearHair</Front_RearHair>
    <Front_Mouth_Normal>Front_Mouth_Normal</Front_Mouth_Normal>
    <Front_Mouth_Attack>Front_Mouth_Attack</Front_Mouth_Attack>
    <Front_Mouth_Hit>Front_Mouth_Hit</Front_Mouth_Hit>
    <Front_Brow_Normal>Front_Brow_Normal</Front_Brow_Normal>
    <Front_Eye>Front_Eye</Front_Eye>
  </FaceInfo>

  <!-- 服装/动作配置 -->
  <ClothInfo>
    <Name>角色名</Name>

    <!-- 默认站姿 -->
    <Default size_x="512" size_y="512" quality="50">
      <Direction>Front</Direction>
      <Pivot pivot_x="0" pivot_y="-300" />
      <Head head_x="0" head_y="0" rotation="0" head_enable="False" />
    </Default>

    <!-- 其他动作配置格式相同 -->
    <Guard size_x="512" size_y="512" quality="50">...</Guard>
    <Evade>...</Evade>
    <Damaged>...</Damaged>
    <Slash>...</Slash>
    <Hit>...</Hit>
    <Penetrate>...</Penetrate>
    <Move>...</Move>
    <Fire>...</Fire>
    <S1>...</S1>
    <!-- S2 ~ S15 -->
  </ClothInfo>
</ModInfo>
```

### 关键参数说明

| 参数 | 说明 |
|------|------|
| `Extended="true"` | 启用ExtendedLoader扩展功能 |
| `size_x/size_y` | 图片尺寸（像素） |
| `quality` | 像素密度，通常为50，影响角色缩放 |
| `pivot_x/pivot_y` | 角色锚点位置，用于定位角色在场景中的位置 |
| `Direction` | `Front`（正面）或 `Side`（侧面） |
| `head_enable` | 是否启用独立头部 |

---

## 四、攻击特效位置配置

在 `<ClothInfo>` 中添加 `<AtkEffectPivotInfo>` 来配置攻击特效的生成位置：

```xml
<AtkEffectPivotInfo>
  <!-- 特效根节点 -->
  <atkEffectRoot>
    <localPosition x="0" y="1.94" z="0"/>
    <localScale x="1" y="1" z="1"/>
    <localEulerAngles x="0" y="0" z="0"/>
  </atkEffectRoot>

  <!-- 打击特效位置 -->
  <atkEffectPivot_H>
    <localPosition x="0.8" y="2.85" z="0"/>
    <localScale x="1" y="1" z="1"/>
    <localEulerAngles x="0" y="0" z="0"/>
  </atkEffectPivot_H>

  <!-- 斩击特效位置 -->
  <atkEffectPivot_J>
    <localPosition x="-1.4" y="-0.6" z="0"/>
    <localScale x="1" y="1" z="1"/>
    <localEulerAngles x="0" y="0" z="8"/>
  </atkEffectPivot_J>

  <!-- 穿刺特效位置 -->
  <atkEffectPivot_Z>
    <localPosition x="-6.4" y="0.85" z="0"/>
    <localScale x="1" y="1" z="1"/>
    <localEulerAngles x="0" y="0" z="0"/>
  </atkEffectPivot_Z>

  <!-- 防御/回避/特殊/远程 -->
  <atkEffectPivot_G>...</atkEffectPivot_G>
  <atkEffectPivot_E>...</atkEffectPivot_E>
  <atkEffectPivot_S>...</atkEffectPivot_S>
  <atkEffectPivot_F>...</atkEffectPivot_F>
</AtkEffectPivotInfo>
```

### 锚点类型对照表

| 节点 | 对应动作 |
|------|----------|
| `atkEffectPivot_H` | 打击 (Hit) |
| `atkEffectPivot_J` | 斩击 (Slash) |
| `atkEffectPivot_Z` | 穿刺 (Penetrate) |
| `atkEffectPivot_G` | 防御 (Guard) |
| `atkEffectPivot_E` | 回避 (Evade) |
| `atkEffectPivot_S` | 特殊动作 (Special) |
| `atkEffectPivot_F` | 远程攻击 (Fire) |

### 特殊动作特效位置

```xml
<SpecialMotionPivotInfo>
  <Evade>
    <localPosition x="0.7" y="1.8" z="0"/>
    <localScale x="1" y="1" z="1"/>
    <localEulerAngles x="0" y="0" z="0"/>
  </Evade>
  <S1>...</S1>
  <S2>...</S2>
  <!-- S3 ~ S15 -->
</SpecialMotionPivotInfo>
```

---

## 五、动作音效绑定

在 `<ClothInfo>` 中添加 `<SoundList>` 来绑定动作音效：

```xml
<SoundList>
  <!-- Motion: 动作类型, WinExternal: 是否使用外部文件, Win: 音效文件名 -->
  <SoundInfo Motion="H" WinExternal="true" Win="Hit.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="H2" WinExternal="true" Win="Hit.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="J" WinExternal="true" Win="Slash.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="J2" WinExternal="true" Win="Slash.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="Z" WinExternal="true" Win="Penetrate.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="Z2" WinExternal="true" Win="Penetrate.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="G" WinExternal="true" Win="Guard.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="E" WinExternal="true" Win="Evasion.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="F" WinExternal="true" Win="Gun.wav" LoseExternal="false" Lose=""/>
  <SoundInfo Motion="S1" WinExternal="true" Win="S1.wav" LoseExternal="false" Lose=""/>
  <!-- S2 ~ S15 -->
</SoundList>
```

### 音效文件放置位置

```
Char/[皮肤名称]/MotionSound/
├── Hit.wav
├── Slash.wav
├── Penetrate.wav
├── Guard.wav
├── Evasion.wav
├── Gun.wav
└── S1.wav ~ S15.wav
```

### Motion类型对照表

| Motion | 对应动作 |
|--------|----------|
| H / H2 | 打击 |
| J / J2 | 斩击 |
| Z / Z2 | 穿刺 |
| G | 防御 |
| E | 回避 |
| F | 远程攻击 |
| N | 普通攻击 |
| S / S1~S15 | 特殊动作 |

### 音效文件格式

| 属性 | 推荐值 |
|------|--------|
| 格式 | WAV 或 OGG |
| 采样率 | 44100 Hz |
| 位深度 | 16-bit |
| 声道 | 单声道或立体声 |

---

## 六、特效系统底层原理

### 游戏特效架构

Library of Ruina 的战斗特效基于 Unity 的 MonoBehaviour 和 Animator 组件。所有骰子攻击特效都继承自 `Battle.DiceAttackEffect.DiceAttackEffect` 基类。

### DiceAttackEffect 基类核心结构

```csharp
// 游戏源码: Assembly-CSharp/Battle/DiceAttackEffect/DiceAttackEffect.cs
namespace Battle.DiceAttackEffect
{
    [RequireComponent(typeof(SpriteRenderer), typeof(Animator))]
    public class DiceAttackEffect : MonoBehaviour
    {
        protected SpriteRenderer spr;           // 精灵渲染器
        protected Animator animator;            // 动画控制器
        protected float _destroyTime;           // 特效持续时间
        protected BattleUnitModel _self;        // 使用者
        protected Transform _selfTransform;     // 使用者位置
        protected Transform _targetTransform;   // 目标位置

        [SerializeField] protected Vector2 offset;
        [SerializeField] protected Vector3 additionalScale;

        // 初始化 - 根据名称后缀自动定位到对应锚点
        public virtual void Initialize(BattleUnitView self, BattleUnitView target, float destroyTime)
        {
            // 名称包含 "H" -> Hit锚点
            // 名称包含 "J" -> Slash锚点
            // 名称包含 "Z" -> Penetrate锚点
            // 名称包含 "G" -> Guard锚点
        }

        protected virtual void Update()
        {
            _elapsed += Time.deltaTime;
            if (_elapsed >= _destroyTime)
                Object.Destroy(gameObject);
        }
    }
}
```

### 特效加载流程

```
1. XML配置 EffectRes="MyEffect_J"
       ↓
2. DiceEffectManager.CreateBehaviourEffect() 被调用
       ↓
3. BaseMod拦截检查 CustomEffects 字典
       ↓
4a. 找到自定义类 → 创建 GameObject 并添加组件
4b. 未找到 → 从原版资源加载 Prefab
       ↓
5. 调用 Initialize() 设置位置和参数
       ↓
6. 特效播放，到时间后自动销毁
```

### 特效名称与锚点的对应关系

特效会根据名称后缀自动附加到角色的对应攻击锚点：

| 名称后缀 | 锚点类型 |
|----------|----------|
| `_H` | 打击锚点 |
| `_J` | 斩击锚点 |
| `_Z` | 穿刺锚点 |
| `_G` | 防御锚点 |
| `_E` | 回避锚点 |
| `_F` | 远程攻击锚点 |

---

## 七、自定义特效类（C#方式）

### BaseMod 自动注册机制

BaseMod 会自动扫描 DLL 中所有继承自 `DiceAttackEffect` 且类名以 `DiceAttackEffect_` 开头的类：

```csharp
// BaseMod 自动注册逻辑
if (type.IsSubclassOf(typeof(DiceAttackEffect)) && name.StartsWith("DiceAttackEffect_"))
{
    CustomEffects[name.Substring("DiceAttackEffect_".Length).Trim()] = type;
}
```

**命名规则**：
- 类名：`DiceAttackEffect_MyEffect_J`
- XML引用：`EffectRes="MyEffect_J"`

### 创建自定义特效类示例

```csharp
using Battle.DiceAttackEffect;
using UnityEngine;

// 类名必须以 DiceAttackEffect_ 开头
// 后缀 _J 表示斩击特效
public class DiceAttackEffect_MyMod_FlameSlash_J : DiceAttackEffect
{
    private float _intensity = 1f;

    public override void Initialize(BattleUnitView self, BattleUnitView target, float destroyTime)
    {
        base.Initialize(self, target, destroyTime);
        // 自定义初始化逻辑
        CreateFlameEffect();
    }

    private void CreateFlameEffect()
    {
        // 动态创建粒子系统
        GameObject particleObj = new GameObject("FlameParticles");
        particleObj.transform.SetParent(transform);
        particleObj.transform.localPosition = Vector3.zero;

        var ps = particleObj.AddComponent<ParticleSystem>();
        var main = ps.main;
        main.startColor = new Color(1f, 0.5f, 0f);
        main.startSize = 0.5f;
        main.startLifetime = 0.3f;
    }

    protected override void Update()
    {
        base.Update();
        _intensity = Mathf.Lerp(_intensity, 0f, Time.deltaTime * 2f);
    }
}
```

### 在XML中使用

```xml
<Behaviour Min="4" Dice="8" Type="Atk" Detail="Slash" Motion="J"
           EffectRes="MyMod_FlameSlash_J" Script="" Desc="" />
```

---

## 八、使用原版特效

### 常用原版特效列表

| 特效名称 | 说明 |
|----------|------|
| `Basic_H` / `Basic_J` / `Basic_Z` | 基础特效 |
| `ch1_H` / `ch1_J` / `ch1_Z` | 第一章风格 |
| `ch2_H` / `ch2_J` / `ch2_Z` | 第二章风格 |
| `Street_H` / `Street_J` / `Street_Z` | 街头风格 |
| `Hook_H` / `Hook_J` / `Hook_Z` | 钩子事务所风格 |
| `Zwei_H` / `Zwei_J` / `Zwei_Z` | 茨威风格 |
| `Yun_H` / `Yun_J` / `Yun_Z` | 云风格 |
| `Molar_H` / `Molar_J` / `Molar_Z` | 臼齿事务所风格 |
| `Stray_H` / `Stray_J` / `Stray_Z` | 流浪者风格 |
| `Pierr_H` / `Pierr_J` / `Pierr_Z` | 皮埃尔风格 |

### 在XML中引用

```xml
<!-- 使用茨威斩击特效 -->
<Behaviour Min="4" Dice="8" Type="Atk" Detail="Slash" Motion="J"
           EffectRes="Zwei_J" Script="" Desc="" />

<!-- 不指定特效（使用默认） -->
<Behaviour Min="4" Dice="8" Type="Atk" Detail="Slash" Motion="J"
           EffectRes="" Script="" Desc="" />
```

---

## 九、AssetBundle特效制作

### 所需工具

| 工具 | 版本/说明 |
|------|-----------|
| Unity | **2019.4.40f1**（必须与游戏版本一致） |
| AssetStudio | 用于提取游戏原版资源作为参考 |
| 图像编辑软件 | Photoshop / GIMP / Aseprite |

### 特效Prefab结构

```
MyEffect_J (GameObject)
├── SpriteRenderer (组件) - 必需
├── Animator (组件) - 必需
└── [自定义脚本] (可选)
```

### 创建特效动画

1. **准备精灵序列帧**
   - 格式：PNG，带透明通道
   - 建议尺寸：256x256 或 512x512
   - 帧数：通常 8-16 帧

2. **在Unity中创建动画**
   - 将精灵序列拖入场景
   - 创建 Animation Clip
   - 设置帧率（通常 24-30 FPS）

3. **设置Animator Controller**
   - 创建 Animator Controller
   - 添加动画状态，设为自动播放

### 导出AssetBundle

```csharp
// Editor/BuildAssetBundles.cs
using UnityEditor;
using System.IO;

public class BuildAssetBundles
{
    [MenuItem("Assets/Build AssetBundles")]
    static void BuildAllAssetBundles()
    {
        string outputPath = "Assets/AssetBundles";
        if (!Directory.Exists(outputPath))
            Directory.CreateDirectory(outputPath);

        BuildPipeline.BuildAssetBundles(
            outputPath,
            BuildAssetBundleOptions.None,
            BuildTarget.StandaloneWindows64
        );
    }
}
```

### 放置位置

```
SteriaModFolder/
└── Assemblies/
    └── AB/
        ├── mymod_effects           # AssetBundle文件
        └── mymod_effects.manifest  # 清单文件
```

---

## 十、纯代码特效（无需Unity）

如果不想使用Unity，可以完全用代码创建特效。

### 使用LineRenderer创建激光特效

```csharp
public class DiceAttackEffect_MyMod_Laser_J : DiceAttackEffect
{
    private LineRenderer _line;
    private float _progress = 0f;

    public override void Initialize(BattleUnitView self, BattleUnitView target, float destroyTime)
    {
        base.Initialize(self, target, destroyTime);

        _line = gameObject.AddComponent<LineRenderer>();
        _line.material = new Material(Shader.Find("Sprites/Default"));
        _line.startColor = Color.cyan;
        _line.endColor = Color.white;
        _line.startWidth = 0.3f;
        _line.endWidth = 0.1f;
        _line.positionCount = 2;
        _line.SetPosition(0, _selfTransform.position);
        _line.SetPosition(1, _selfTransform.position);
    }

    protected override void Update()
    {
        base.Update();
        _progress += Time.deltaTime / _destroyTime;

        if (_line != null && _targetTransform != null)
        {
            Vector3 targetPos = Vector3.Lerp(
                _selfTransform.position,
                _targetTransform.position,
                _progress);
            _line.SetPosition(1, targetPos);

            // 渐隐效果
            Color c = _line.startColor;
            c.a = 1f - _progress;
            _line.startColor = c;
            _line.endColor = c;
        }
    }
}
```

### 使用SpriteRenderer创建闪光特效

```csharp
public class DiceAttackEffect_MyMod_Flash_H : DiceAttackEffect
{
    protected override void Awake()
    {
        base.Awake();

        if (spr != null)
        {
            // 创建圆形渐变精灵
            Texture2D tex = new Texture2D(64, 64);
            for (int x = 0; x < 64; x++)
            {
                for (int y = 0; y < 64; y++)
                {
                    float dist = Vector2.Distance(new Vector2(x, y), new Vector2(32, 32));
                    float alpha = Mathf.Clamp01(1f - dist / 32f);
                    tex.SetPixel(x, y, new Color(1, 1, 1, alpha));
                }
            }
            tex.Apply();
            spr.sprite = Sprite.Create(tex, new Rect(0, 0, 64, 64), new Vector2(0.5f, 0.5f));
            spr.color = Color.yellow;
        }
    }

    protected override void Update()
    {
        base.Update();

        // 闪烁和缩放动画
        float alpha = Mathf.PingPong(Time.time * 10f, 1f);
        if (spr != null)
            spr.color = new Color(1, 1, 0, alpha);

        float scale = 1f + Mathf.Sin(Time.time * 20f) * 0.2f;
        transform.localScale = Vector3.one * scale * 2f;
    }
}
```

---

## 十一、资源总结

### 角色皮肤资源

| 资源类型 | 放置位置 |
|----------|----------|
| AssetBundle皮肤 | `Resource/AssetBundle/[皮肤名]` |
| 散图皮肤 | `Char/[皮肤名]/` |
| 皮肤配置 | `Char/[皮肤名]/ModInfo.xml` |
| 动作音效 | `Char/[皮肤名]/MotionSound/` |

### 特效资源

| 资源类型 | 放置位置 |
|----------|----------|
| AssetBundle特效 | `Assemblies/AB/[包名]` |
| C#特效类 | `Assemblies/[Mod].dll` 中 |

### 制作工具推荐

| 用途 | 工具 |
|------|------|
| 角色立绘 | Photoshop / Clip Studio Paint / Aseprite |
| 特效动画 | After Effects / Spine / Unity |
| 音效编辑 | Audacity / Adobe Audition |
| AssetBundle打包 | Unity 2019.4.40f1 |
| 资源提取 | AssetStudio |
