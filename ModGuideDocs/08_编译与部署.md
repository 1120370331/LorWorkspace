# 编译与部署操作手册

## 一、开发环境准备

### 必需软件

| 软件 | 用途 |
|------|------|
| Visual Studio 2019/2022 | C#开发IDE |
| .NET Framework 4.7.2 SDK | 编译目标框架 |

---

## 二、创建C#项目

### 步骤1：新建项目

1. 打开Visual Studio
2. 文件 → 新建 → 项目
3. 选择 **类库 (.NET Framework)**
4. 框架选择 **.NET Framework 4.7.2**
5. 项目名称如 `MyMod`

### 步骤2：项目文件配置 (.csproj)

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net472</TargetFramework>
    <AssemblyName>MyMod</AssemblyName>
    <OutputType>Library</OutputType>
    <LangVersion>latest</LangVersion>
  </PropertyGroup>

  <ItemGroup>
    <!-- 游戏核心引用 -->
    <Reference Include="Assembly-CSharp">
      <HintPath>..\Libs\Assembly-CSharp.dll</HintPath>
      <Private>false</Private>
    </Reference>

    <!-- Harmony库 -->
    <Reference Include="0Harmony">
      <HintPath>..\Libs\0Harmony.dll</HintPath>
      <Private>false</Private>
    </Reference>

    <!-- BaseMod框架 -->
    <Reference Include="BaseMod">
      <HintPath>..\Libs\BaseMod.dll</HintPath>
      <Private>false</Private>
    </Reference>

    <!-- Unity引用 -->
    <Reference Include="UnityEngine.CoreModule">
      <HintPath>..\Libs\UnityEngine.CoreModule.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="UnityEngine">
      <HintPath>..\Libs\UnityEngine.dll</HintPath>
      <Private>false</Private>
    </Reference>
  </ItemGroup>
</Project>
```

---

## 三、获取引用DLL

### DLL来源

| DLL | 位置 |
|-----|------|
| `Assembly-CSharp.dll` | 游戏目录 `LibraryOfRuina_Data/Managed/` |
| `0Harmony.dll` | BaseMod或其他模组的Assemblies目录 |
| `BaseMod.dll` | BaseMod模组目录 |
| `UnityEngine*.dll` | 游戏目录 `LibraryOfRuina_Data/Managed/` |

### 游戏安装目录

```
Steam版本：
C:\Program Files (x86)\Steam\steamapps\common\Library Of Ruina\

GOG版本：
C:\GOG Games\Library of Ruina\
```

### 复制DLL到Libs目录

```
YourModProject/
├── Libs/
│   ├── Assembly-CSharp.dll
│   ├── 0Harmony.dll
│   ├── BaseMod.dll
│   ├── UnityEngine.dll
│   └── UnityEngine.CoreModule.dll
├── MyMod.csproj
└── MyMod.cs
```

---

## 四、编译方法

### 方法1：Visual Studio编译

1. 打开解决方案 (.sln)
2. 选择 **Release** 配置
3. 生成 → 生成解决方案 (Ctrl+Shift+B)
4. 输出位于 `bin/Release/net472/MyMod.dll`

### 方法2：命令行编译 (dotnet CLI)

```bash
# 进入项目目录
cd YourModProject

# 编译Release版本
dotnet build -c Release

# 输出位置
# bin/Release/net472/MyMod.dll
```

### 方法3：命令行编译 (MSBuild)

```bash
# 使用MSBuild
msbuild MyMod.csproj /p:Configuration=Release

# 或使用Visual Studio Developer Command Prompt
devenv MyMod.sln /build Release
```

---

## 五、部署到游戏

### 模组目录结构

```
游戏目录/Mods/MyMod/
├── Assemblies/
│   └── MyMod.dll              ← 编译输出
├── Data/
│   ├── CardInfo.xml
│   ├── PassiveList.xml
│   └── ...
├── Localize/
│   └── cn/
│       └── ...
├── Resource/
│   └── CombatPageArtwork/
│       └── ...
└── StageModInfo.xml
```

### 自动复制脚本 (Post-Build Event)

在项目属性 → 生成事件 → 后期生成事件中添加：

```batch
xcopy /Y "$(TargetPath)" "C:\Program Files (x86)\Steam\steamapps\common\Library Of Ruina\Mods\MyMod\Assemblies\"
```

或在.csproj中添加：

```xml
<Target Name="PostBuild" AfterTargets="PostBuildEvent">
  <Copy SourceFiles="$(TargetPath)"
        DestinationFolder="C:\Path\To\Game\Mods\MyMod\Assemblies\" />
</Target>
```

---

## 六、调试配置

### 附加到游戏进程

1. 启动游戏
2. Visual Studio → 调试 → 附加到进程
3. 选择 `LibraryOfRuina.exe`
4. 设置断点进行调试

### 启用调试日志

```csharp
using UnityEngine;

public class MyMod
{
    public static void Log(string message)
    {
        Debug.Log($"[MyMod] {message}");
    }
}
```

日志输出位置：
```
%USERPROFILE%\AppData\LocalLow\Project Moon\LibraryOfRuina\Player.log
```

---

## 七、常见编译错误

### 错误1：找不到类型或命名空间

```
error CS0246: 找不到类型或命名空间名"BattleUnitModel"
```

**解决：** 添加Assembly-CSharp.dll引用

### 错误2：程序集版本冲突

```
warning CS1701: 假定程序集引用与标识匹配
```

**解决：** 确保使用与游戏版本匹配的DLL

### 错误3：目标框架不匹配

```
error : 项目的目标框架版本高于引用的程序集
```

**解决：** 将目标框架改为.NET Framework 4.7.2

### 错误4：Harmony方法签名错误

```
error CS0115: 没有找到适合的方法来重写
```

**解决：** 检查方法签名是否与基类一致

---

## 八、发布检查清单

- [ ] 编译为Release版本
- [ ] 移除调试代码和Debug.Log
- [ ] 检查所有XML文件编码为UTF-8
- [ ] 检查ID不与其他模组冲突
- [ ] 测试所有功能正常
- [ ] 准备preview.jpg预览图
- [ ] 编写StageModInfo.xml

---

## 九、Steam创意工坊发布

### 步骤

1. 将模组放入游戏Mods目录
2. 启动游戏
3. 进入模组管理界面
4. 选择上传到创意工坊
5. 填写标题、描述、标签
6. 上传

### 更新模组

1. 修改本地模组文件
2. 在游戏中选择更新
3. 填写更新日志

---

## 十、参考项目结构

```
MyModProject/
├── Libs/                      # 引用DLL
│   ├── Assembly-CSharp.dll
│   ├── 0Harmony.dll
│   ├── BaseMod.dll
│   └── UnityEngine*.dll
│
├── src/                       # 源代码
│   ├── Passives/
│   │   └── PassiveAbility_MyPassive.cs
│   ├── Cards/
│   │   ├── DiceCardSelfAbility_MyCard.cs
│   │   └── DiceCardAbility_MyDice.cs
│   ├── Buffs/
│   │   └── BattleUnitBuf_MyBuff.cs
│   └── ModInitializer.cs
│
├── MyMod.csproj
├── MyMod.sln
│
└── Output/                    # 最终模组包
    └── MyMod/
        ├── Assemblies/
        │   └── MyMod.dll
        ├── Data/
        ├── Localize/
        ├── Resource/
        └── StageModInfo.xml
```
